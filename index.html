<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éƒ¨ä¸‹ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚µãƒã‚¤ãƒãƒ«</title>
    <!-- Tailwind CSS (ãƒ‡ã‚¶ã‚¤ãƒ³ç”¨) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM (ã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel (ã‚³ãƒ¼ãƒ‰å¤‰æ›ç”¨) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center p-2">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ã‚¢ã‚¤ã‚³ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (SVG) ---
        // å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã‚ãšã€ç›´æ¥æç”»ã—ã¦è»½é‡åŒ–
        const IconBase = ({ children, color = "currentColor", size = 24, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>{children}</svg>
        );
        const Briefcase = (p) => <IconBase {...p}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></IconBase>;
        const MessageCircle = (p) => <IconBase {...p}><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></IconBase>;
        const Coffee = (p) => <IconBase {...p}><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" x2="6" y1="2" y2="4"/><line x1="10" x2="10" y1="2" y2="4"/><line x1="14" x2="14" y1="2" y2="4"/></IconBase>;
        const History = (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/><path d="M12 7v5l4 2"/></IconBase>;
        const UserMinus = (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="22" x2="16" y1="11" y2="11"/></IconBase>;
        const Award = (p) => <IconBase {...p}><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></IconBase>;
        const RefreshCw = (p) => <IconBase {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>;

        // --- ã‚²ãƒ¼ãƒ å®šæ•° & ãƒ‡ãƒ¼ã‚¿ ---
        const MAX_WEEKS = 12;

        const MENTAL_STATES = [
            { id: 'conflict', label: 'è‘›è—¤ãƒ»æŠµæŠ—', subLabel: '(æ€’ã‚Šã¨å¯¾ç«‹)', colorBg: '#FDE047', colorBorder: '#EAB308' },
            { id: 'resignation', label: 'è«¦ã‚ãƒ»é©å¿œ', subLabel: '', colorBg: '#BBF7D0', colorBorder: '#86EFAC' },
            { id: 'quiet_quit', label: 'é™ã‹ãªé€€è·', subLabel: '', colorBg: '#A5F3FC', colorBorder: '#67E8F9' },
            { id: 'apathy', label: 'ç„¡é–¢å¿ƒ', subLabel: '', colorBg: '#93C5FD', colorBorder: '#60A5FA' },
            { id: 'turnover', label: 'é€€è·ãƒ»è»¢å‡º', subLabel: '(å±é™º)', colorBg: '#C4B5FD', colorBorder: '#A78BFA' },
            { id: 'growth', label: 'å……å®Ÿãƒ»æˆé•·', subLabel: '(ç†æƒ³)', colorBg: '#DCA598', colorBorder: '#B97A6D' },
            { id: 'waver', label: 'æºã‚‰ããƒ»è¿·ã„', subLabel: '', colorBg: '#E7CBA9', colorBorder: '#D4A373' },
        ];

        const generateInitialStats = () => ({
            inst_fairness: Math.floor(30 + Math.random() * 40),
            inter_fairness: Math.floor(30 + Math.random() * 40),
            autonomy: Math.floor(30 + Math.random() * 40),
            competence: Math.floor(30 + Math.random() * 40),
            psych_load: Math.floor(20 + Math.random() * 30),
            phys_energy: Math.floor(60 + Math.random() * 40)
        });

        const ActionType = {
            WORK: 'work',
            COMMUNICATION: 'comm',
            REST: 'rest'
        };

        const pickMsg = (messages) => messages[Math.floor(Math.random() * messages.length)];

        const ACTIONS = [
            {
                id: 'praise',
                label: 'æˆæœã‚’è¤’ã‚ã‚‹',
                type: ActionType.COMMUNICATION,
                desc: 'å…·ä½“çš„ãªæˆæœã‚’æ‰¿èªã™ã‚‹',
                effect: (stats) => ({
                    inst_fairness: +2, inter_fairness: +5, autonomy: 0, competence: +10, psych_load: -5, phys_energy: 0
                }),
                getMessages: (success) => success ? [
                    "ã€Œã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ãã“ã€ã“ã ã‚ã£ãŸã‚“ã§ã™ï¼ã€",
                    "ã€Œéƒ¨é•·ã«ãã†è¨€ã£ã¦ã‚‚ã‚‰ãˆã‚‹ã¨ã€è‡ªä¿¡ã«ãªã‚Šã¾ã™ï¼ã€",
                    "ã€Œã‚„ã£ãŸï¼æ¬¡ã¯ã‚‚ã£ã¨ã„ã„ã‚‚ã®ä½œã‚Šã¾ã™ã­ï¼ã€"
                ] : [
                    "ã€Œã‚ã€ã¯ã„...ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ˆå¿ƒãªã—ã‹å£°ãŒå°ã•ã„ï¼‰ã€",
                    "ã€Œã¯ã‚...ï¼ˆã‚‚ã£ã¨åˆ¥ã®ã¨ã“ã‚ã‚’è¦‹ã¦ã»ã—ã„ã‚“ã ã‘ã©ãª...ï¼‰ã€"
                ]
            },
            {
                id: 'scold',
                label: 'å³ã—ãæŒ‡å°',
                type: ActionType.WORK,
                desc: 'æ”¹å–„ç‚¹ã‚’æŒ‡æ‘˜ã—ä¿®æ­£ã•ã›ã‚‹',
                effect: (stats) => {
                    const isTrusted = stats.inter_fairness > 60;
                    return {
                        inst_fairness: +2, inter_fairness: isTrusted ? 0 : -10, autonomy: -5, competence: isTrusted ? +5 : -10, psych_load: +15, phys_energy: -5
                    };
                },
                getMessages: (success) => success ? [
                    "ã€Œç¢ºã‹ã«ãã†ã§ã™ã­...ã€‚æ¬¡ã‹ã‚‰ã¯çµ¶å¯¾ã«æ°—ã‚’ã¤ã‘ã¾ã™ï¼ã€",
                    "ã€Œã”æŒ‡æ‘˜ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã™ãã«ä¿®æ­£ã—ã¾ã™ï¼ã€",
                    "ã€Œã†ã£...ç—›ã„ã¨ã“ã‚ã‚’...ã€‚ã§ã‚‚ã€ãŠã£ã—ã‚ƒã‚‹é€šã‚Šã§ã™ã€‚ã€"
                ] : [
                    "ã€Œã™ã„ã¾ã›ã‚“...ï¼ˆãªã‚“ã§è‡ªåˆ†ã°ã£ã‹ã‚Š...ï¼‰ã€",
                    "ã€Œ...ã¯ã„ã€ã‚ã‹ã‚Šã¾ã—ãŸã€‚ï¼ˆç´å¾—ã„ã‹ãªã„é¡”ã‚’ã—ã¦ã„ã‚‹ï¼‰ã€",
                    "ã€Œï¼ˆã¾ãŸæ€’ã‚‰ã‚ŒãŸ...ã‚‚ã†å«Œã ãª...ï¼‰ã€"
                ]
            },
            {
                id: 'delegate',
                label: 'ä»•äº‹ã‚’ä»»ã›ã‚‹',
                type: ActionType.WORK,
                desc: 'æ¨©é™å§”è­²ã—ã¦è¦‹å®ˆã‚‹',
                effect: (stats) => ({
                    inst_fairness: 0, inter_fairness: +2, autonomy: +15, competence: +5, psych_load: +10, phys_energy: -10
                }),
                getMessages: (success) => [
                    "ã€Œã“ã‚Œã€åƒ•ãŒã‚„ã£ã¦ã„ã„ã‚“ã§ã™ã‹ï¼Ÿ ã‚„ã‚Šã¾ã™ï¼ã€",
                    "ã€Œè²¬ä»»é‡å¤§ã§ã™ã­...ã§ã‚‚ã€ãƒãƒ£ãƒ³ã‚¹ã ã¨æ€ã£ã¦é ‘å¼µã‚Šã¾ã™ï¼ã€",
                    "ã€Œä»»ã›ã¦ãã ã•ã„ï¼æœŸå¾…ä»¥ä¸Šã®çµæœã‚’å‡ºã—ã¦ã¿ã›ã¾ã™ã‚ˆã€‚ã€"
                ]
            },
            {
                id: 'micro_manage',
                label: 'ç´°ã‹ãæŒ‡ç¤ºå‡ºã—',
                type: ActionType.WORK,
                desc: 'é€²æ—ã‚’ç´°éƒ¨ã¾ã§ç®¡ç†ã™ã‚‹',
                effect: (stats) => ({
                    inst_fairness: +5, inter_fairness: -2, autonomy: -15, competence: -5, psych_load: +5, phys_energy: -5
                }),
                getMessages: (success) => [
                    "ã€Œã‚ã€ã¯ã„ã€‚ãã®é€šã‚Šã«é€²ã‚ã¾ã™...ï¼ˆã‚„ã‚Šã¥ã‚‰ã„ãªãï¼‰ã€",
                    "ã€Œå ±å‘Šã§ã™ã­ã€‚ãˆãˆã¨ã€ä»Šã¯...ï¼ˆç›£è¦–ã•ã‚Œã¦ã‚‹ã¿ãŸã„ã ï¼‰ã€",
                    "ã€Œç´°éƒ¨ã¾ã§ç¢ºèªã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™...ï¼ˆä¿¡ç”¨ã•ã‚Œã¦ãªã„ã®ã‹ãªï¼‰ã€"
                ]
            },
            {
                id: 'listen',
                label: '1on1ã§å‚¾è´',
                type: ActionType.COMMUNICATION,
                desc: 'ä¸æº€ã‚„ã‚­ãƒ£ãƒªã‚¢ã®ç›¸è«‡ã«ä¹—ã‚‹',
                effect: (stats) => ({
                    inst_fairness: +2, inter_fairness: +10, autonomy: +2, competence: +2, psych_load: -10, phys_energy: 0
                }),
                getMessages: (success) => [
                    "ã€Œå®Ÿã¯æœ€è¿‘ã€å°‘ã—æ‚©ã‚“ã§ã„ã¦...èã„ã¦ãã‚Œã¾ã™ã‹ï¼Ÿã€",
                    "ã€Œéƒ¨é•·ã¨ã“ã†ã—ã¦è©±ã›ã‚‹ã¨ã€é ­ã®ä¸­ãŒæ•´ç†ã§ãã¾ã™ã€‚ã€",
                    "ã€Œã‚ãƒ¼ã€ã‚¹ãƒƒã‚­ãƒªã—ã¾ã—ãŸï¼ èã„ã¦ã‚‚ã‚‰ãˆã¦ã‚ˆã‹ã£ãŸã§ã™ã€‚ã€"
                ]
            },
            {
                id: 'explain_rule',
                label: 'è©•ä¾¡åˆ¶åº¦ã®èª¬æ˜',
                type: ActionType.COMMUNICATION,
                desc: 'è©•ä¾¡åŸºæº–ã®é€æ˜æ€§ã‚’ä¼ãˆã‚‹',
                effect: (stats) => ({
                    inst_fairness: +15, inter_fairness: +2, autonomy: 0, competence: 0, psych_load: 0, phys_energy: -2
                }),
                getMessages: (success) => [
                    "ã€Œãªã‚‹ã»ã©ã€ãã†ã„ã†åŸºæº–ã ã£ãŸã‚“ã§ã™ã­ã€‚ã‚¯ãƒªã‚¢ã«ãªã‚Šã¾ã—ãŸã€‚ã€",
                    "ã€Œä½•ã‚’ç›®æŒ‡ã›ã°ã„ã„ã‹åˆ†ã‹ã£ã¦ã€ãƒ¢ãƒ¤ãƒ¢ãƒ¤ãŒæ™´ã‚Œã¾ã—ãŸï¼ã€",
                    "ã€Œå…¬å¹³ã«è¦‹ã¦ãã‚Œã¦ã‚‹ã£ã¦åˆ†ã‹ã£ã¦å®‰å¿ƒã—ã¾ã—ãŸã€‚ã€"
                ]
            },
            {
                id: 'rest',
                label: 'ä¼‘æ¯ã‚’ä¿ƒã™',
                type: ActionType.REST,
                desc: 'æ—©å¸°ã‚Šã‚’æ¨å¥¨ã™ã‚‹',
                effect: (stats) => ({
                    inst_fairness: 0, inter_fairness: +5, autonomy: 0, competence: 0, psych_load: -10, phys_energy: +15
                }),
                getMessages: (success) => [
                    "ã€Œãˆã€ã„ã„ã‚“ã§ã™ã‹ï¼Ÿ ã˜ã‚ƒã‚ã€ãŠè¨€è‘‰ã«ç”˜ãˆã¦...ã€",
                    "ã€ŒåŠ©ã‹ã‚Šã¾ã™...æœ€è¿‘ã¡ã‚‡ã£ã¨å¯ä¸è¶³æ°—å‘³ã ã£ãŸã®ã§ã€‚ã€",
                    "ã€Œã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ä»Šæ—¥ã¯ã‚†ã£ãã‚Šé¢¨å‘‚ã«å…¥ã£ã¦å¯ã¾ã™ï¼ã€"
                ]
            },
            {
                id: 'drink',
                label: 'é£²ã¿ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³',
                type: ActionType.REST,
                desc: 'è…¹ã‚’å‰²ã£ã¦è©±ã™',
                effect: (stats) => {
                    const success = Math.random() > 0.4;
                    return {
                        inst_fairness: 0, inter_fairness: success ? +10 : -5, autonomy: 0, competence: 0, psych_load: success ? -5 : +5, phys_energy: -10
                    };
                },
                getMessages: (success) => success ? [
                    "ã€Œã„ã‚„ãƒ¼ã€éƒ¨é•·ãŒãã‚“ãªéå»ã‚’æŒã£ã¦ãŸã¨ã¯ï¼é¢ç™½ã„ã§ã™ï¼ã€",
                    "ã€Œä»Šæ—¥èª˜ã£ã¦ã‚‚ã‚‰ãˆã¦è‰¯ã‹ã£ãŸã§ã™ã€‚æ˜æ—¥ã‹ã‚‰ã¾ãŸé ‘å¼µã‚Šã¾ã™ï¼ã€",
                    "ã€Œã¶ã£ã¡ã‚ƒã‘ã¾ã™ã‘ã©...éƒ¨é•·ã®ã“ã¨ã€æœ€åˆã¯æ€–ã‹ã£ãŸã‚“ã§ã™ã‚ˆï¼ˆç¬‘ï¼‰ã€"
                ] : [
                    "ã€Œã‚ã€æ˜æ—¥æ—©ã„ã‚“ã§ã€ãã‚ãã‚...ï¼ˆæ™‚è¨ˆã‚’ãƒãƒ©ãƒãƒ©è¦‹ã¦ã„ã‚‹ï¼‰ã€",
                    "ã€Œã¯ã¯...ãã†ã§ã™ã­...ï¼ˆè©±é•·ã„ãªã...å¸°ã‚ŠãŸã„ï¼‰ã€",
                    "ã€Œã™ã„ã¾ã›ã‚“ã€ã¡ã‚‡ã£ã¨é…”ã„ãŒå›ã£ã¡ã‚ƒã£ã¦...ï¼ˆæ°—ç–²ã‚Œã—ãŸã‚ˆã†ã ï¼‰ã€"
                ]
            }
        ];

        const RANDOM_EVENTS = [
            { title: "ä¸é€æ˜ãªäººäº‹ç•°å‹•", desc: "ã€Œãªã‚“ã§ã‚ã®äººãŒæ˜‡é€²ã™ã‚‹ã‚“ã§ã™ã‹...ï¼Ÿã€éƒ¨ä¸‹ãŒä¸ä¿¡æ„Ÿã‚’æŠ±ã„ã¦ã„ã‚‹ã€‚", effect: { inst_fairness: -15, inter_fairness: 0, autonomy: 0, competence: 0, psych_load: +5, phys_energy: 0 } },
            { title: "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå¤§æˆåŠŸ", desc: "ã€Œã‚„ã‚Šã¾ã—ãŸã­éƒ¨é•·ï¼ç§ãŸã¡æœ€é«˜ã˜ã‚ƒãªã„ã§ã™ã‹ï¼ï¼Ÿã€", effect: { inst_fairness: +5, inter_fairness: 0, autonomy: 0, competence: +15, psych_load: -5, phys_energy: -5 } },
            { title: "ç¹å¿™æœŸçªå…¥", desc: "ã€Œçµ‚ã‚ã‚‰ãªã„...å…¨ç„¶ä»•äº‹ãŒçµ‚ã‚ã‚‰ãªã„ã§ã™ã‚ˆ...ã€", effect: { inst_fairness: 0, inter_fairness: 0, autonomy: -5, competence: 0, psych_load: +10, phys_energy: -15 } },
            { title: "ç†ä¸å°½ãªã‚¯ãƒ¬ãƒ¼ãƒ ", desc: "ã€Œç§ã€ä½•ã‚‚æ‚ªããªã„ã®ã«...ã‚‚ã†ç–²ã‚Œã¾ã—ãŸ...ã€", effect: { inst_fairness: 0, inter_fairness: 0, autonomy: -5, competence: -5, psych_load: +15, phys_energy: -10 } },
            { title: "æ–°ã—ã„ãƒ„ãƒ¼ãƒ«ã®å°å…¥", desc: "ã€Œã“ã‚Œå‡„ã„ï¼é¢å€’ãªä½œæ¥­ãŒä¸€ç¬ã§çµ‚ã‚ã‚Šã¾ã™ï¼ã€", effect: { inst_fairness: +5, inter_fairness: 0, autonomy: +5, competence: +5, psych_load: -5, phys_energy: +5 } }
        ];

        function SubordinateSurvival() {
            const [gameState, setGameState] = useState('start'); 
            const [week, setWeek] = useState(1);
            const [stats, setStats] = useState(generateInitialStats());
            const [parameterChanges, setParameterChanges] = useState({});
            const [lastMessage, setLastMessage] = useState("");
            const [eventMessage, setEventMessage] = useState(null);
            const [history, setHistory] = useState([]);
            const [currentActions, setCurrentActions] = useState([]);
            const [gameOverReason, setGameOverReason] = useState("");
            const logsEndRef = useRef(null);

            useEffect(() => {
                logsEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [history]);

            // ã‚²ãƒ¼ãƒ é–‹å§‹
            const startGame = () => {
                setStats(generateInitialStats()); 
                setParameterChanges({});
                setWeek(1);
                setGameState('playing');
                setLastMessage("ã€Œä»ŠæœŸã‚‚ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€éƒ¨é•·ï¼ã€");
                setEventMessage(null);
                setHistory([]);
                pickRandomActions();
            };

            // é¸æŠè‚¢ã®ãƒ©ãƒ³ãƒ€ãƒ æŠ½å‡º
            const pickRandomActions = () => {
                const shuffled = [...ACTIONS].sort(() => 0.5 - Math.random());
                setCurrentActions(shuffled.slice(0, 3));
            };

            // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†
            const handleAction = (action) => {
                const changes = action.effect(stats);
                let newStats = { ...stats };
                
                Object.keys(changes).forEach(key => {
                    newStats[key] += changes[key];
                });

                setParameterChanges(changes);

                let isSuccess = true;
                if (action.id === 'scold' && stats.inter_fairness <= 60) isSuccess = false;
                if (action.id === 'drink' && changes.inter_fairness < 0) isSuccess = false;
                if (action.id === 'praise' && stats.competence > 90) isSuccess = true;

                const possibleMessages = action.getMessages(isSuccess);
                const actionMsg = pickMsg(possibleMessages);
                
                setLastMessage(actionMsg);
                
                const newHistory = [...history, { week, type: 'action', text: `${action.label}: ${actionMsg}` }];

                // ãƒ©ãƒ³ãƒ€ãƒ ã‚¤ãƒ™ãƒ³ãƒˆ
                let evtMsg = null;
                if (Math.random() < 0.25 && week < MAX_WEEKS) {
                    const evt = RANDOM_EVENTS[Math.floor(Math.random() * RANDOM_EVENTS.length)];
                    Object.keys(evt.effect).forEach(key => {
                        newStats[key] += evt.effect[key];
                    });
                    evtMsg = evt;
                    newHistory.push({ week, type: 'event', text: `âš¡ ${evt.desc}` });
                }
                setEventMessage(evtMsg);
                setHistory(newHistory);

                // å€¤ã®æ­£è¦åŒ–
                Object.keys(newStats).forEach(key => {
                    newStats[key] = Math.max(0, Math.min(100, newStats[key]));
                });

                setStats(newStats);
                checkGameState(newStats, week);
            };

            // ã‚²ãƒ¼ãƒ çŠ¶æ…‹åˆ¤å®š
            const checkGameState = (currentStats, currentWeek) => {
                if (currentStats.psych_load >= 100) { finishGame('burnout'); return; }
                if (currentStats.phys_energy <= 0) { finishGame('exhaustion'); return; }
                if (currentStats.inst_fairness <= 0 || currentStats.inter_fairness <= 0) { finishGame('distrust'); return; }
                if (currentStats.competence <= 0) { finishGame('loss_confidence'); return; }

                if (currentWeek >= MAX_WEEKS) {
                    finishGame('victory');
                } else {
                    setWeek(prev => prev + 1);
                    pickRandomActions();
                }
            };

            const finishGame = (reason) => {
                let reasonText = "";
                switch(reason) {
                    case 'burnout': reasonText = "ã€Œã‚‚ã†ç„¡ç†ã§ã™...ä¼šç¤¾ã«æ¥ã‚‹ã®ãŒæ€–ãã¦...ã€ä¼‘è·é¡˜ãŒå‡ºã•ã‚Œã¾ã—ãŸã€‚ï¼ˆåŸå› ï¼šå¿ƒç†çš„è² è·ã®é™ç•Œï¼‰"; break;
                    case 'exhaustion': reasonText = "æ·±å¤œã€éƒ¨ä¸‹ãŒã‚ªãƒ•ã‚£ã‚¹ã§å€’ã‚Œæ•‘æ€¥æ¬é€ã•ã‚Œã¾ã—ãŸã€‚ï¼ˆåŸå› ï¼šèº«ä½“çš„ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®æ¯æ¸‡ï¼‰"; break;
                    case 'distrust': reasonText = "ã€Œã“ã®ä¼šç¤¾ã§æ­£å½“ã«è©•ä¾¡ã•ã‚Œã‚‹æœªæ¥ãŒè¦‹ãˆã¾ã›ã‚“ã€‚ã€é€€è·å±ŠãŒå‡ºã•ã‚Œã¾ã—ãŸã€‚ï¼ˆåŸå› ï¼šå…¬å¹³æ€§ã®æ¬ å¦‚ï¼‰"; break;
                    case 'loss_confidence': reasonText = "ã€Œåƒ•ã«ã¯è·ãŒé‡ã™ãã¾ã—ãŸ...ã”è¿·æƒ‘ã‚’ãŠã‹ã‘ã—ã¾ã—ãŸã€‚ã€é€€è·å±ŠãŒå‡ºã•ã‚Œã¾ã—ãŸã€‚ï¼ˆåŸå› ï¼šæœ‰ç”¨æ„Ÿã®å–ªå¤±ï¼‰"; break;
                    default: reasonText = "éƒ¨ä¸‹ã¯é€€è·ã—ã¾ã—ãŸã€‚";
                }
                setGameOverReason(reasonText);
                setGameState(reason === 'victory' ? 'victory' : 'gameover');
            };

            // --- çŠ¶æ…‹åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ---
            const determineMentalStateId = (s) => {
                if (s.psych_load > 85 || s.phys_energy < 15 || s.inst_fairness < 15 || s.inter_fairness < 15) return 'turnover'; 
                if (s.inst_fairness < 40 && s.inter_fairness < 40 && s.phys_energy > 40) return 'conflict';
                if (s.autonomy < 40 && s.psych_load < 60) return 'resignation'; 
                if (s.competence < 40 && s.autonomy < 40) return 'quiet_quit'; 
                if (s.phys_energy < 40 && s.competence < 40) return 'apathy'; 
                if (s.autonomy > 60 && s.competence > 60 && s.phys_energy > 50 && s.inst_fairness > 50) return 'growth'; 
                return 'waver'; 
            };

            const currentMentalStateId = determineMentalStateId(stats);
            const currentStateIndex = MENTAL_STATES.findIndex(s => s.id === currentMentalStateId);
            const rotationAngle = -currentStateIndex * (360 / MENTAL_STATES.length); // å††å…¨ä½“ã‚’å›ã™è§’åº¦

            // --- UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---

            const ProgressBar = ({ label, value, change, color }) => (
                <div className="mb-2.5 w-full">
                    <div className="flex justify-between items-end text-xs text-white mb-0.5 px-0.5">
                        <span className="font-medium bg-slate-900/50 px-1 rounded">{label}</span>
                        <div className="flex gap-1 items-baseline">
                            {change !== 0 && change !== undefined && (
                                <span className={`text-[10px] ${change > 0 ? 'text-green-300' : 'text-red-300'}`}>
                                    {change > 0 ? 'â–²' : 'â–¼'}{Math.abs(change)}
                                </span>
                            )}
                            <span className="font-mono font-bold text-sm">{value}</span>
                        </div>
                    </div>
                    <div className="w-full bg-slate-700/50 h-2.5 rounded-sm overflow-hidden backdrop-blur-sm border border-slate-600/50">
                        <div 
                            className="h-full transition-all duration-500 rounded-sm" 
                            style={{ width: `${value}%`, backgroundColor: color }}
                        />
                    </div>
                </div>
            );

            return (
                <div className="max-w-xl w-full bg-white rounded-xl shadow-2xl overflow-hidden border border-slate-200 flex flex-col max-h-[95vh]">
                    
                    {/* Header */}
                    <div className="bg-slate-800 text-white p-3 flex justify-between items-center shrink-0">
                        <h1 className="font-bold text-lg flex items-center gap-2">
                            <Briefcase size={20} />
                            çµ„ç¹”å¿ƒç†å­¦ã‚µãƒã‚¤ãƒãƒ«
                        </h1>
                        <div className="text-sm bg-slate-700 px-3 py-1 rounded-full font-mono">
                            Week {gameState === 'start' ? 1 : week} / {MAX_WEEKS}
                        </div>
                    </div>

                    {/* Start Screen */}
                    {gameState === 'start' && (
                        <div className="p-8 text-center overflow-y-auto">
                            <div className="mb-6 text-6xl">ğŸ¢</div>
                            <h2 className="text-2xl font-bold mb-4">ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆãƒ»ã‚µãƒã‚¤ãƒãƒ«</h2>
                            <p className="text-gray-600 mb-8 leading-relaxed text-sm">
                                ã‚ãªãŸã¯ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã¨ã—ã¦ã€<br/>
                                éƒ¨ä¸‹ã®6ã¤ã®å¿ƒç†ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç®¡ç†ã—ã¾ã™ã€‚<br/><br/>
                                <strong>éƒ¨ä¸‹ã®å¿ƒç†ã¯å¸¸ã«å¤‰åŒ–ï¼ˆå›è»¢ï¼‰ã—ã¾ã™ã€‚</strong><br/>
                                ã€Œç¾åœ¨ã®çŠ¶æ…‹ã€ãŒçœŸä¸Šï¼ˆ12æ™‚ï¼‰ã«æ¥ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<br/>
                                çŠ¶æ…‹ã‚’è¦‹æ¥µã‚ã€ã€Œå……å®Ÿãƒ»æˆé•·ã€ã¸å°ã„ã¦ãã ã•ã„ã€‚
                            </p>
                            <button 
                                onClick={startGame}
                                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg shadow-lg"
                            >
                                ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆé–‹å§‹ï¼ˆåˆæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”Ÿæˆï¼‰
                            </button>
                        </div>
                    )}

                    {/* Main Game Screen */}
                    {gameState === 'playing' && (
                        <div className="flex flex-col h-full overflow-hidden relative">
                            <div className="p-2 overflow-y-auto flex-1 flex flex-col items-center">
                                
                                {/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ */}
                                <div className="w-full mb-2 px-2 z-20 relative">
                                    <div className="bg-slate-100 px-4 py-3 rounded-lg text-sm text-slate-700 w-full text-center border border-slate-200 min-h-[3.5rem] flex items-center justify-center shadow-inner italic">
                                        {lastMessage}
                                    </div>
                                    {eventMessage && (
                                        <div className="bg-yellow-50 px-4 py-2 mt-1 rounded text-xs text-yellow-800 text-center border border-yellow-200 animate-pulse font-bold">
                                            âš¡ {eventMessage.title}: {eventMessage.desc}
                                        </div>
                                    )}
                                </div>

                                {/* å††ç’°çŠ¶ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹UI - å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ */}
                                <div className="relative w-[360px] h-[360px] mb-2 shrink-0 mx-auto flex items-center justify-center overflow-hidden">
                                    
                                    {/* å›è»¢ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ */}
                                    <div 
                                        className="absolute w-full h-full flex items-center justify-center transition-transform duration-1000 ease-in-out"
                                        style={{ transform: `rotate(${rotationAngle}deg)` }}
                                    >
                                        {/* è»Œé“ã®ç‚¹ç·šå†† */}
                                        <div className="absolute w-[300px] h-[300px] rounded-full border-2 border-dashed border-slate-300"></div>

                                        {/* å‘¨å›²ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å†† */}
                                        {MENTAL_STATES.map((state, index) => {
                                            const angle = index * (360 / MENTAL_STATES.length);
                                            const radius = 150; // å††ã®åŠå¾„
                                            const isActive = state.id === currentMentalStateId;

                                            return (
                                                <div
                                                    key={state.id}
                                                    className="absolute flex flex-col items-center justify-center text-center transition-all duration-500"
                                                    style={{
                                                        top: '50%',
                                                        left: '50%',
                                                        marginTop: '-3rem', // w-24 h-24 ã®åŠåˆ†
                                                        marginLeft: '-3rem',
                                                        transform: `rotate(${angle}deg) translate(0, -${radius}px) rotate(${-angle}deg) rotate(${-rotationAngle}deg)` 
                                                        // æœ€å¾Œã®rotateã¯ã€è¦ªã®å›è»¢ã‚’æ‰“ã¡æ¶ˆã—ã¦æ–‡å­—ã‚’æ­£ç«‹ã•ã›ã‚‹ãŸã‚
                                                    }}
                                                >
                                                    <div 
                                                        className={`w-24 h-24 rounded-full flex flex-col items-center justify-center shadow-lg border-2 transition-all duration-500 ${isActive ? 'scale-110 ring-4 ring-offset-2 ring-yellow-200 font-bold z-10' : 'bg-white/90 border-slate-300 opacity-60'}`}
                                                        style={{ 
                                                            backgroundColor: isActive ? state.colorBg : undefined,
                                                            borderColor: isActive ? state.colorBorder : undefined
                                                        }}
                                                    >
                                                        <span className="text-sm text-slate-800 leading-tight px-2">{state.label}</span>
                                                        {state.subLabel && <span className="text-[10px] text-slate-500 mt-1">{state.subLabel}</span>}
                                                    </div>
                                                    {isActive && (
                                                        <div className="absolute -bottom-8 bg-slate-800 text-white text-[10px] px-2 py-1 rounded shadow animate-bounce whitespace-nowrap z-20">
                                                            ç¾åœ¨: {state.label}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>

                                    {/* ä¸­å¤®ã®é»’å††ï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚³ãƒ³ãƒ†ãƒŠ - å›è»¢ã—ãªã„ï¼‰ */}
                                    <div className="absolute w-60 h-60 bg-slate-800 rounded-full flex flex-col justify-center px-6 shadow-2xl z-30 border-4 border-slate-600">
                                        <ProgressBar label="å…¬å¹³æ€§(åˆ¶åº¦)" value={stats.inst_fairness} change={parameterChanges.inst_fairness} color="#60A5FA" />
                                        <ProgressBar label="å…¬å¹³æ€§(å¯¾äºº)" value={stats.inter_fairness} change={parameterChanges.inter_fairness} color="#818CF8" />
                                        <ProgressBar label="è£é‡æ„Ÿ" value={stats.autonomy} change={parameterChanges.autonomy} color="#4ADE80" />
                                        <ProgressBar label="æœ‰ç”¨æ„Ÿ" value={stats.competence} change={parameterChanges.competence} color="#2DD4BF" />
                                        <ProgressBar label="å¿ƒç†çš„è² è·" value={stats.psych_load} change={parameterChanges.psych_load} color="#F472B6" />
                                        <ProgressBar label="èº«ä½“ã‚¨ãƒŠã‚¸ãƒ¼" value={stats.phys_energy} change={parameterChanges.phys_energy} color="#FB923C" />
                                    </div>

                                </div>

                                {/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */}
                                <div className="w-full space-y-2 mt-2 z-20 relative">
                                    <h3 className="text-xs font-bold text-gray-500 mb-1 flex items-center gap-2">
                                        <Briefcase size={14} />
                                        ä»Šé€±ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ©ãƒ³ãƒ€ãƒ é¸å‡ºï¼‰
                                    </h3>
                                    <div className="grid grid-cols-1 gap-2">
                                        {currentActions.map((action) => (
                                            <button
                                                key={action.id}
                                                onClick={() => handleAction(action)}
                                                className="w-full text-left bg-white hover:bg-slate-50 border-2 border-slate-200 hover:border-blue-400 p-2.5 rounded-xl transition-all duration-200 group relative overflow-hidden shadow-sm active:scale-[0.98]"
                                            >
                                                <div className="flex justify-between items-center relative z-10">
                                                    <div className="flex-1 min-w-0">
                                                        <span className="font-bold text-slate-800 text-sm block truncate">{action.label}</span>
                                                        <span className="text-[10px] text-slate-500 block truncate">{action.desc}</span>
                                                    </div>
                                                    <div className="ml-2 bg-slate-50 text-slate-400 p-1.5 rounded-full group-hover:bg-blue-100 group-hover:text-blue-600 transition-colors shrink-0">
                                                        {action.type === ActionType.COMMUNICATION && <MessageCircle size={16} />}
                                                        {action.type === ActionType.WORK && <Briefcase size={16} />}
                                                        {action.type === ActionType.REST && <Coffee size={16} />}
                                                    </div>
                                                </div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* å±¥æ­´ãƒ­ã‚° */}
                            <div className="bg-slate-100 border-t border-slate-200 p-2 h-20 shrink-0 z-20 relative">
                                <h4 className="text-[10px] font-bold text-gray-500 mb-1 flex items-center gap-1">
                                    <History size={10} />
                                    å±¥æ­´
                                </h4>
                                <div className="h-full overflow-y-auto pb-4 text-[10px] space-y-1 pr-1 custom-scrollbar">
                                    {history.map((log, i) => (
                                        <div key={i} className={`p-1 rounded ${log.type === 'event' ? 'bg-yellow-100 text-yellow-800' : 'bg-white text-gray-600 border border-slate-200'}`}>
                                            <span className="font-mono text-gray-400 mr-1">W{log.week}</span>
                                            {log.text}
                                        </div>
                                    ))}
                                    <div ref={logsEndRef} />
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Game Over / Victory Screen */}
                    {(gameState === 'gameover' || gameState === 'victory') && (
                        <div className={`p-8 text-center h-full overflow-y-auto flex flex-col justify-center ${gameState === 'victory' ? 'bg-blue-50' : 'bg-red-50'}`}>
                            {gameState === 'victory' ? (
                                <>
                                    <Award size={64} className="mx-auto text-yellow-500 mb-4" />
                                    <h2 className="text-xl font-bold text-blue-900 mb-2">QUARTER COMPLETE!</h2>
                                    <p className="text-blue-700 mb-6 text-sm">ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆæˆåŠŸã§ã™</p>
                                </>
                            ) : (
                                <>
                                    <UserMinus size={64} className="mx-auto text-red-500 mb-4" />
                                    <h2 className="text-xl font-bold text-red-800 mb-2">GAME OVER</h2>
                                    <div className="bg-white p-4 rounded-lg shadow-sm border border-red-100 mb-8 text-left relative mt-6">
                                        <div className="absolute -top-3 left-4 bg-red-100 text-red-800 text-xs px-2 py-1 rounded">é€€è·/ä¼‘è·å±Š</div>
                                        <p className="text-gray-700 font-serif italic text-sm">{gameOverReason}</p>
                                    </div>
                                </>
                            )}
                            
                            <button 
                                onClick={startGame}
                                className={`w-full text-white font-bold py-3 rounded-lg shadow flex items-center justify-center gap-2 transition ${gameState === 'victory' ? 'bg-blue-600 hover:bg-blue-700' : 'bg-slate-800 hover:bg-slate-900'}`}
                            >
                                <RefreshCw size={18} />
                                {gameState === 'victory' ? 'æ¬¡ã®æœŸã¸' : 'å†æŒ‘æˆ¦ï¼ˆåˆæœŸå€¤ãƒ©ãƒ³ãƒ€ãƒ ï¼‰'}
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SubordinateSurvival />);
    </script>
</body>
</html>
